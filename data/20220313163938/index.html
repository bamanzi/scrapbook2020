<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="profile" href="http://gmpg.org/xfn/11">

                        <link rel="pingback" href="https://blog.robotshell.org/xmlrpc.php">
        
        <title>Content Security Policy 导致 bookmarklet 失效 – Robot Shell</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="https://www.googletagmanager.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Robot Shell » Feed" href="https://blog.robotshell.org/feed/">
<link rel="alternate" type="application/rss+xml" title="Robot Shell » 评论Feed" href="https://blog.robotshell.org/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Robot Shell » Content Security Policy 导致 bookmarklet 失效评论Feed" href="https://blog.robotshell.org/2014/content-security-policy-makes-bookmarklet-unusable/feed/">
<script type="text/javascript">/* Code removed by ScrapBook */</script><script src="about:blank" type="text/javascript" defer=""></script>
<style type="text/css">
/* Code tidied up by ScrapBook */
</style>
	<link rel="stylesheet" id="materialize-google-font-1-css" href="css_001.dat" type="text/css" media="all">
<link rel="stylesheet" id="materialize-google-font-2-css" href="css_002.dat" type="text/css" media="all">
<link rel="stylesheet" id="materialize-google-font-3-css" href="css.dat" type="text/css" media="all">
<link rel="stylesheet" id="fontello-css" href="fontello.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-effects-css" href="effects.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-header-css" href="header.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-materialize-css" href="materialize.min.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-typography-css" href="typography.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-navigation-css" href="navigation.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-nav-css" href="nav.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-blog-css" href="blog.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-forms-css" href="forms.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-elements-css" href="elements.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-widgets-css" href="widgets.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-comments-css" href="comments.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-comments-typography-css" href="comments-typography.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-footer-css" href="footer.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-pretty-photo-css" href="prettyPhoto.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-plugins-css" href="plugins.css" type="text/css" media="all">
<link rel="stylesheet" id="mythemes-style-css" href="style.css" type="text/css" media="all">
<!--[if IE]>
<link rel='stylesheet' id='materialize-ie-css'  href='https://blog.robotshell.org/wp-content/themes/materialize/media/_frontend/css/ie.css?ver=0.0.21' type='text/css' media='all' />
<![endif]-->
<link rel="stylesheet" id="wp-block-library-css" href="style.min.css" type="text/css" media="all">
<style id="global-styles-inline-css" type="text/css">
/* Code tidied up by ScrapBook */
body { --wp--preset--color--black: #000000; --wp--preset--color--cyan-bluish-gray: #abb8c3; --wp--preset--color--white: #ffffff; --wp--preset--color--pale-pink: #f78da7; --wp--preset--color--vivid-red: #cf2e2e; --wp--preset--color--luminous-vivid-orange: #ff6900; --wp--preset--color--luminous-vivid-amber: #fcb900; --wp--preset--color--light-green-cyan: #7bdcb5; --wp--preset--color--vivid-green-cyan: #00d084; --wp--preset--color--pale-cyan-blue: #8ed1fc; --wp--preset--color--vivid-cyan-blue: #0693e3; --wp--preset--color--vivid-purple: #9b51e0; --wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%); --wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%); --wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%); --wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%); --wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%); --wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%); --wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%); --wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%); --wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%); --wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%); --wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%); --wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%); --wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale'); --wp--preset--duotone--grayscale: url('#wp-duotone-grayscale'); --wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow'); --wp--preset--duotone--blue-red: url('#wp-duotone-blue-red'); --wp--preset--duotone--midnight: url('#wp-duotone-midnight'); --wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow'); --wp--preset--duotone--purple-green: url('#wp-duotone-purple-green'); --wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange'); --wp--preset--font-size--small: 13px; --wp--preset--font-size--medium: 20px; --wp--preset--font-size--large: 36px; --wp--preset--font-size--x-large: 42px; }
</style>
<link rel="stylesheet" id="wp-pagenavi-css" href="pagenavi-css.css" type="text/css" media="all">
<link rel="stylesheet" id="codecolorer-css" href="codecolorer.css" type="text/css" media="screen">
<script type="text/javascript" src="about:blank" id="prototype-js"></script>
<script type="text/javascript" src="about:blank" id="scriptaculous-root-js"></script>
<script type="text/javascript" src="about:blank" id="scriptaculous-effects-js"></script>
<script type="text/javascript" src="about:blank" id="lightbox-js"></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://blog.robotshell.org/wp-content/themes/materialize/media/_frontend/js/respond.min.js?ver=0.0.21' id='respond-js'></script>
<![endif]-->
<!--[if lt IE 9]>
<script type='text/javascript' src='https://blog.robotshell.org/wp-content/themes/materialize/media/_frontend/js/html5shiv.min.js?ver=0.0.21' id='html5shiv-js'></script>
<![endif]-->
<script type="text/javascript" src="about:blank" id="jquery-core-js"></script>
<script type="text/javascript" src="about:blank" id="jquery-migrate-js"></script>

<!-- Google Analytics snippet added by Site Kit -->
<script type="text/javascript" src="about:blank" id="google_gtagjs-js" async=""></script>
<script type="text/javascript" id="google_gtagjs-js-after">/* Code removed by ScrapBook */</script>

<!-- End Google Analytics snippet added by Site Kit -->
<link rel="https://api.w.org/" href="https://blog.robotshell.org/wp-json/"><link rel="alternate" type="application/json" href="https://blog.robotshell.org/wp-json/wp/v2/posts/453"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blog.robotshell.org/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://blog.robotshell.org/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 5.9.2">
<link rel="canonical" href="https://blog.robotshell.org/2014/content-security-policy-makes-bookmarklet-unusable/">
<link rel="shortlink" href="https://blog.robotshell.org/?p=453">
<link rel="alternate" type="application/json+oembed" href="https://blog.robotshell.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.robotshell.org%2F2014%2Fcontent-security-policy-makes-bookmarklet-unusable%2F">
<link rel="alternate" type="text/xml+oembed" href="https://blog.robotshell.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.robotshell.org%2F2014%2Fcontent-security-policy-makes-bookmarklet-unusable%2F&amp;format=xml">
<meta name="generator" content="Site Kit by Google 1.69.0">
	<!-- begin lightbox scripts -->
	<script type="text/javascript">/* Code removed by ScrapBook */</script><link rel="stylesheet" href="lightbox.css" type="text/css" media="screen">
	<!-- end lightbox scripts -->
<!--[if IE]>
	<style type="text/css" id="tempo-custom-css-ie">
			</style>
<![endif]-->


<!--[if IE 11]>
	<style type="text/css" id="tempo-custom-css-ie-11">
			</style>
<![endif]-->


<!--[if IE 10]>
	<style type="text/css" id="tempo-custom-css-ie-10">
			</style>
<![endif]-->

<!--[if IE 9]>
	<style type="text/css" id="tempo-custom-css-ie-9">
			</style>
<![endif]-->

<!--[if IE 8]>
	<style type="text/css" id="tempo-custom-css-ie-8">
			</style>
<![endif]-->

<style type="text/css">
/* Code tidied up by ScrapBook */
body { background-color: rgb(255, 255, 255); }
body > div.content {  }
</style>

<style type="text/css" id="mythemes-breadcrumbs-space">
/* Code tidied up by ScrapBook */
div.mythemes-page-header { padding-top: 15px; padding-bottom: 15px; }
</style>

<!-- colors options / background color -->
<style type="text/css" id="mythemes-background-color">
/* Code tidied up by ScrapBook */
body > div.content { background-color: rgb(245, 245, 245); }
</style>

<!-- header options -->
<!-- header content -->
<!-- header content headline color -->
<style type="text/css" id="mythemes-header-headline-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header content description color and description hover color -->
<style type="text/css" id="mythemes-header-description-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header buttons -->
<!-- header first button -->
<!-- header first button text color -->
<style type="text/css" id="mythemes-header-btn-1-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header first button background color -->
<style type="text/css" id="mythemes-header-btn-1-bkg-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header first button background hover color -->
<style type="text/css" id="mythemes-header-btn-1-bkg-h-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header second button -->
<!-- header second button text color -->
<style type="text/css" id="mythemes-header-btn-2-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header second button background color -->
<style type="text/css" id="mythemes-header-btn-2-bkg-color" media="all">
/* Code tidied up by ScrapBook */
</style>

<!-- header second button background hover color -->
<style type="text/css" id="mythemes-header-btn-2-bkg-h-color" media="all">
/* Code tidied up by ScrapBook */
</style>
<style type="text/css">
/* Code tidied up by ScrapBook */
</style>    <style>
/* Code tidied up by ScrapBook */
</style></head>
<body class="post-template-default single single-post postid-453 single-format-standard"><div class="content"><div class="container"><div class="row"><section class="col s12 m12 l9 mythemes-classic"><article class="post-453 post type-post status-publish format-standard hentry category-internet category-programming tag-bookmarklet tag-firefox tag-javascript tag-security"><!--DOCUMENT_FRAGMENT--><h1 class="post-title">Content Security Policy 导致 bookmarklet 失效</h1>

                                <!-- the post top meta: author / time / comments -->
                                        <div class="mythemes-top-meta meta">

            <!-- date -->
            
            <time datetime="2014-02-08"><i class="materialize-icon-calendar"></i>on 2014-02-08</time>

            <div class="clear"></div>

            <!-- categories -->
            <ul class="post-categories">
	<li></li></ul></div><!--/DOCUMENT_FRAGMENT--><div class="mythemes-top-meta meta"><ul class="post-categories"><!--DOCUMENT_FRAGMENT-->
	<li></li><!--/DOCUMENT_FRAGMENT--></ul><!--DOCUMENT_FRAGMENT-->
            <!-- author -->
                        <!--/DOCUMENT_FRAGMENT--><!--DOCUMENT_FRAGMENT-->

            <!-- comments -->
            <!--/DOCUMENT_FRAGMENT--></div><!--DOCUMENT_FRAGMENT--><!-- .mythemes-top-meta -->

                                <!-- the post content wrapper -->
                                <div class="post-content">

                                    <!-- the post content -->
                                    <p>近来发现在知乎、 Github 上我最常用的 bookmarklet （书签小工具，就是那种一句话 Javascript 书签）——饭否分享失效了。打开 Console 一看，有这样的提示：“Content Security Policy: 页面设置阻止读取一项资源：已经阻止执行内联脚本。”大概是孤陋寡闻，之前还没听说过 Content Security Policy 这玩意儿，猜测又是和 Cross-Origin Resource Sharing 有关系的什么东西，就做了一番搜索。</p>
<p>CSP 是一个可以限制页面中哪些 src （包括脚本、图片等等）可以被允许的实验性 HTTP Header 。这是 <a href="http://www.w3.org/TR/CSP/" target="_blank">W3C Candidate Recommendation</a> ，而这个是 MDN 上的<a href="https://developer.mozilla.org/en-US/docs/Security/CSP/Introducing_Content_Security_Policy" target="_blank">相关资料</a>。简而言之又是一个 defend by depth 的产物，可以给 XSS 防范再加上一层保险：直接禁止掉 inline script 和 inline eval ，然后给出一个允许加载的资源域的白名单，这样即使有 XSS 过滤漏洞，也无法注入站外的脚本。</p>
<p>但是问题就来了：用户直接在地址栏里输入的 Javascript 应该被允许么？ Bookmarklet 应该被允许么？ W3 文档这么说：</p>
<blockquote><p>
Enforcing a CSP policy should not interfere with the operation of user-supplied scripts such as third-party user-agent add-ons and JavaScript bookmarklets.
</p></blockquote>
<p>可事实是 Firefox （ Chrome 估计也是）没有正确实现，把 bookmarklet 也给拦截了，同时拦截掉了的还有 Lastpass 这样的插件的 JS 脚本，这也顺便解释了为什么 Lastpass 在知乎首页上无法自动填充的问题。</p>
<p>Github 博客上介绍这个新措施的<a href="https://github.com/blog/1477-content-security-policy" target="_blank">文章</a>里也提到了这个问题，并且给出了一个“解决方案”——直接把浏览器的 CSP 支持给禁用就好了……</p></div><!--/DOCUMENT_FRAGMENT--></article></section></div></div></div></body>
</html>
