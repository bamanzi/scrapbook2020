<!DOCTYPE html>
<html style="" class="applicationcache geolocation history postmessage svg no-websockets localstorage sessionstorage no-websqldatabase webworkers hashchange pointerevents canvas audio canvastext video webgl cssgradients multiplebgs opacity rgba inlinesvg hsla supports svgclippaths smil no-touchevents fontface generatedcontent textshadow cssanimations backgroundsize borderimage borderradius boxshadow csscolumns csscolumns-width csscolumns-span csscolumns-fill csscolumns-gap csscolumns-rule csscolumns-rulecolor csscolumns-rulestyle csscolumns-rulewidth no-csscolumns-breakbefore no-csscolumns-breakafter no-csscolumns-breakinside flexbox flexboxlegacy no-cssreflections csstransforms csstransforms3d csstransitions indexeddb indexeddb-deletedatabase js ibm-v18 ibm-cxtype-na no-hires linux firefox firefox9 gecko gecko9 ibm-grid-xlarge greater-china-imt" lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="index.css" media="screen">


<!-- End Wayback Rewrite JS Include -->

	
      
<link rel="shortcut icon" href="favicon.ico">




	


<title>技巧: 使用truss、strace或ltrace诊断软件的"疑难杂症"</title>
    

	
    



    
<!-- Segment meta tag -->
      
<!-- SITE MON : START (DO NOT DELETE) -->
<!-- developerWorks monitoring token -->
<!-- SITE MON : END (DO NOT DELETE) -->

<!-- HEADER_SCRIPTS_AND_CSS_INCLUDE -->
<!-- <script src="//cdn.optimizely.com/js/5399420604.js"></script> -->
<!-- BEGIN: Use this section to set page specific variables for the Page Tag -->

<!--END -->




    

   
<!--  Masthead/footer  -->

<!-- <link href="//dw1.s81c.com/developerworks/css/dw-mf/v18/alt-signedin-ux.css" rel="stylesheet" /> -->   
<!--[if lt IE 9]>
    <link href="//dw1.s81c.com/developerworks/css/dw-mf/v18/dw-mf-ie8fix.css?v=022216" rel="stylesheet" />
<![endif]-->




     

     



<!-- 
<PageMap>
    <DataObject type="document">
        <Attribute name="topic">Shells</Attribute>
        <Attribute name="topicId">247</Attribute>
        <Attribute name="contentArea">linux</Attribute>
        <Attribute name="contentAreaId">2</Attribute>
        <Attribute name="abstract">本文通过三个实际案例演示如何使用truss、strace和ltrace这三个常用的调试工具来快速诊断软件的"疑难杂症"。</Attribute>
        <Attribute name="pub.date">2004-12-01</Attribute>
        <Attribute name="contentType">article</Attribute>
    </DataObject>
</PageMap>
-->        

</head><body id="ibm-com" class="ibm-type ibm-sitenav-menu ibm-sitenav-menu-sticky ibm-masthead-sticky ibm-masthead-sticky-showing"><div id="ibm-top" class="ibm-landing-page"><div id="ibm-content-wrapper"><main role="main" aria-label=""><div id="ibm-pcon"><div id="ibm-content"><div id="ibm-content-body"><div id="ibm-content-main" class="dw-article"><div class="ibm-columns dw-article-toc"><div class="ibm-col-6-4"><p class="dw-article-series-head">技巧</p>
                                        <h1 id="ibm-pagetitle-h1" class="ibm-h1">使用truss、strace或ltrace诊断软件的"疑难杂症"</h1>
                                        <!-- Article Top Bar -->
                                                <div class="ibm-columns dw-article-topbar">
                                                    <!-- Author and article info. -->
                                                    <div class="ibm-col-6-2 ibm-col-medium-6-4 dw-article-metadata">
                                                        <div class="dw-article-avatar"><img src="7e0d4a0ffe734de.png" alt="" width="42" height="42"></div><div class="dw-article-authordate">李凯斌<br><span class="dw-article-pubdate">2004 年 12 月 01 日发布</span></div>
                                                    </div>
                                                    <!-- Social -->
                                                    <div class="ibm-col-6-2 ibm-col-medium-6-4 ibm-col-small-6-2 dw-article-social">
                                                        <!-- Sharing links -->
                                                        <!--<div id="dw-article-share-inline">
                                                            <div class="dw-article-sharelink-inline">
                                                                <div class="ibm-sharethispage"></div>
                                                            </div>
                                                        </div>-->
                                                        <!-- Number of comments and link to comments -->
                                                        <!-- <div id="dw-article-cmts">
                                                            <div class="dw-article-cmtslink">
                                                                <a onclick="tocLink('#icomments')" href="#icomments" role="link" tabindex="0" aria-label="Comments">
                                                                    <img src="//dw1.s81c.com/developerworks/i/v18/article/dw-article-cmt-icon.png" width="29" height="29" alt="Comments"/>
                                                                </a>
                                                            </div>
                                                            <div class="dw-article-cmtslink">
                                                                <a onclick="tocLink('#icomments')" href="#icomments" role="link" tabindex="0">
                                                                    <div id="nCmts"></div>
                                                                </a>
                                                            </div>
                                                        </div> -->
                                                    </div>
                                                </div>
<div id="dw-series-container" style="display: block;"><h3 class="ibm-h3" id="dw-series-heading">系列内容：</h3><div data-widget="showhide" data-type="panel" class="ibm-show-hide ibm-widget-processed"><h2 id="dw-series-show-hide"><a href="javascript:void();">此内容是该系列的一部分：<span id="dw-series-title-alt">技巧</span></a></h2><div class="ibm-container-body" id="dw-series-links" style="display: none;"><ul id="dw-series-list"><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipsaxdo4/index.html?ca=drs-" class="dw-series-article-link"> SAX 和文档次序 — 传递最大程度相邻的文本</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipt2dw/index.html?ca=drs-" class="dw-series-article-link"> txt2dw 实用程序</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex1/index.html?ca=drs-" class="dw-series-article-link"> 了解文本实用程序</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipjb5ejb3/index.html?ca=drs-" class="dw-series-article-link"> 从 JBoss 4 迁移到 JBoss 5</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiphtml/index.html?ca=drs-" class="dw-series-article-link"> 从 XSL 样式表输出 HTML</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipatom1/index.html?ca=drs-" class="dw-series-article-link"> 使用 Atom 结构避免在 feed 聚合过程中出现数据重复</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipboot2/index.html?ca=drs-" class="dw-series-article-link"> 使用 DOM 进行自举的基础知识，第 2 部分</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tiprddlphp/index.html?ca=drs-" class="dw-series-article-link"> 使用 PHP 解析 RDDL 文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipsxtf/index.html?ca=drs-" class="dw-series-article-link"> 使用 SAXTransformerFactory</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipstx4/index.html?ca=drs-" class="dw-series-article-link"> 使用 StAX 编写 XML 文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipstx2/index.html?ca=drs-" class="dw-series-article-link"> 使用 StAX 部分解析 XML 文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipxinc/index.html?ca=drs-" class="dw-series-article-link"> 使用 XInclude 同步带有源大纲的 WSDL</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipxsslt/index.html?ca=drs-" class="dw-series-article-link"> 使用 XML Schema Standard Type Library 简化开发</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipstx/index.html?ca=drs-" class="dw-series-article-link"> 使用 XML 流解析器</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipattr/index.html?ca=drs-" class="dw-series-article-link"> 使用 XSLT 转换属性</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex3/index.html?ca=drs-" class="dw-series-article-link"> 使用 head 和 tail 以块方式读取文本流</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-jaxmsoap/index.html?ca=drs-" class="dw-series-article-link"> 使用SAAJ发送和接收SOAP消息</a></li><li class="dw-series-item"> 使用truss、strace或ltrace诊断软件的"疑难杂症"</li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tiplang/index.html?ca=drs-" class="dw-series-article-link"> 使用特定于语言的工具来进行 XML 处理</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipcomp.html?ca=drs-" class="dw-series-article-link"> 压缩 XML 文件以便有效地传输</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/tip19/index.html?ca=drs-" class="dw-series-article-link"> 双引导 Linux</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipvalschm/index.html?ca=drs-" class="dw-series-article-link"> 告诉解析器在哪里可以找到模式</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipfxatt/index.html?ca=drs-" class="dw-series-article-link"> 在 XML 词汇表中使用固定属性</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipcombxslt/index.html?ca=drs-" class="dw-series-article-link"> 如何用 XSLT 组合文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipexc/index.html?ca=drs-" class="dw-series-article-link"> 将 Excel 数据转换成 XML</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiprtf/index.html?ca=drs-" class="dw-series-article-link"> 将 RTF 文档转换成 HTML 文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipword/index.html?ca=drs-" class="dw-series-article-link"> 将 Word 文档转换成 Simple Docbook XML</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiprtfg/index.html?ca=drs-" class="dw-series-article-link"> 将含有图形的 RTF 文档转换成 HTML 文档</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiplocal/index.html?ca=drs-" class="dw-series-article-link"> 文档格式内的本地化</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiprdfai/index.html?ca=drs-" class="dw-series-article-link"> 有效地使用 RDF/XML 中的 rdf:about 和 rdf:ID</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipjaxrpc/index.html?ca=drs-" class="dw-series-article-link"> 用 JAX-RPC 发送与接收 SOAP 消息</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-jaxmsoap/index.html?ca=drs-" class="dw-series-article-link"> 用 JAXM 发送和接收 SOAP 消息</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipsaxxni/index.html?ca=drs-" class="dw-series-article-link"> 用 SAX 和 XNI 检测 XML 文档的编码</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex2/index.html?ca=drs-" class="dw-series-article-link"> 用 cat 合并文件</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex4/index.html?ca=drs-" class="dw-series-article-link"> 用 sort 和 tsort 对文件进行排序</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex5/index.html?ca=drs-" class="dw-series-article-link"> 用 tr 过滤文件</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/linux/l-tip-prompt/l-tiptex6/index.html?ca=drs-" class="dw-series-article-link"> 用 uniq 除去重复行</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipxslmsg.html?ca=drs-" class="dw-series-article-link"> 用 xsl:message 调试样式表</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipsoap/index.html?ca=drs-" class="dw-series-article-link"> 用头元素实现更好的 SOAP 接口</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipoop/index.html?ca=drs-" class="dw-series-article-link"> 用面向对象编程创建有效的 XML</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipherr/index.html?ca=drs-" class="dw-series-article-link"> 让 SOAP 与 Web 服务器和平共处</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tipsaxp/index.html?ca=drs-" class="dw-series-article-link"> 设置 SAX 解析器</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/tips/x-tiplwt/index.html?ca=drs-" class="dw-series-article-link"> 轻量级 XML 库</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipgnu/index.html?ca=drs-" class="dw-series-article-link"> 通过 XML 从外部应用程序直接读取 Gnumeric 电子表格中的数据</a></li><li class="dw-series-item"><a href="https://web.archive.org/web/20200803220616mp_/http://www.ibm.com/developerworks/cn/xml/x-tipapachexhtml/index.html?ca=drs-" class="dw-series-article-link"> 配置 Apache 为 XHTML 发送正确的 MIME 类型</a></li></ul></div></div></div>
                                        <!-- Article Body -->
                                        
                                        <h2 id="N10039" class="ibm-h2">简介</h2><p>进程无法启动，软件运行速度突然变慢，程序的"Segment Fault"等等都是让每个Unix系统用户头痛的问题，本文通过三个实际案例演示如何使用truss、strace和ltrace这三个常用的调试工具来快速诊断软件的"疑难杂症"。</p><p>truss和strace用来
        <strong>跟踪一个进程的系统调用或信号产生的情况</strong>，而 ltrace用来
        <strong>跟踪进程调用库函数的情况</strong>。truss是早期为System V R4开发的调试程序，包括Aix、FreeBSD在内的大部分Unix系统都自带了这个工具；而strace最初是为SunOS系统编写的，ltrace最早出现在GNU/Debian Linux中。这两个工具现在也已被移植到了大部分Unix系统中，大多数Linux发行版都自带了strace和ltrace，而FreeBSD也可通过Ports安装它们。
      </p><p>你不仅可以从命令行调试一个新开始的程序，也可以把truss、strace或ltrace绑定到一个已有的PID上来调试一个正在运行的程序。三个调试工具的基本使用方法大体相同，下面仅介绍三者共有，而且是最常用的三个命令行参数：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_894063" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">-f ：除了跟踪当前进程外，还跟踪其子进程。</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">-o file ：将输出信息写到文件file中，而不是显示到标准错误输出（stderr）。</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">-p pid ：绑定到一个由pid对应的正在运行的进程。此参数常用来调试后台进程。</code></div></div></td></tr></tbody></table></div></div></div></span><p>使用上述三个参数基本上就可以完成大多数调试任务了，下面举几个命令行例子：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_890621" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">truss -o ls.truss ls -al： 跟踪ls -al的运行，将输出信息写到文件/tmp/ls.truss中。</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">strace -f -o vim.strace vim： 跟踪vim及其子进程的运行，将输出信息写到文件vim.strace。</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">ltrace -p 234： 跟踪一个pid为234的已经在运行的进程。</code></div></div></td></tr></tbody></table></div></div></div></span><p>三个调试工具的输出结果格式也很相似，以strace为例：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_874576" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">brk(0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0x8062aa8</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">brk(0x8063000)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0x8063000</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">mmap2(NULL, 4096, PROT_READ, MAP_PRIVATE, 3, 0x92f) = 0x40016000</code></div></div></td></tr></tbody></table></div></div></div></span><p>每一行都是一条系统调用，等号左边是系统调用的函数名及其参数，右边是该调用的返回值。
truss、strace和ltrace的工作原理大同小异，都是使用ptrace系统调用跟踪调试运行中的进程，详细原理不在本文讨论范围内，有兴趣可以参考它们的源代码。</p><p>下面举两个实例演示如何利用这三个调试工具诊断软件的"疑难杂症"：</p><h2 id="N1005E" class="ibm-h2">案例一：运行clint出现Segment Fault错误</h2><p>操作系统：FreeBSD-5.2.1-release</p><p>clint是一个C++静态源代码分析工具，通过Ports安装好之后，运行：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_639138" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># clint foo.cpp</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">Segmentation fault (core dumped)</code></div></div></td></tr></tbody></table></div></div></div></span><p>在Unix系统中遇见"Segmentation Fault"就像在MS Windows中弹出"非法操作"对话框一样令人讨厌。OK，我们用truss给clint"把把脉"：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_829368" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># truss -f -o clint.truss clint</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">Segmentation fault (core dumped)</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain"># tail clint.truss</code></div><div class="line number4 index3 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: read(0x6,0x806f000,0x1000)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4096 (0x1000)</code></div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: fstat(6,0xbfbfe4d0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0 (0x0)</code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: fcntl(0x6,0x3,0x0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4 (0x4)</code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: fcntl(0x6,0x4,0x0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0 (0x0)</code></div><div class="line number8 index7 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: close(6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0 (0x0)</code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">739: stat("/root/.clint/plugins",0xbfbfe680)&nbsp;&nbsp; ERR#2 'No such file or directory'</code></div><div class="line number10 index9 alt1"><code class="htmlscript plain">SIGNAL 11</code></div><div class="line number11 index10 alt2"><code class="htmlscript plain">SIGNAL 11</code></div><div class="line number12 index11 alt1"><code class="htmlscript plain">Process stopped because of:&nbsp; 16</code></div><div class="line number13 index12 alt2"><code class="htmlscript plain">process exit, rval = 139</code></div></div></td></tr></tbody></table></div></div></div></span><p>我们用truss跟踪clint的系统调用执行情况，并把结果输出到文件clint.truss，然后用tail查看最后几行。注意看clint执行的最后一条系统调用（倒数第五行）：
        <code>stat("/root/.clint/plugins",0xbfbfe680)   ERR#2 'No such file or directory'</code>，问题就出在这里：clint找不到目录"/root/.clint/plugins"，从而引发了段错误。怎样解决？很简单：
        <code>mkdir -p /root/.clint/plugins</code>，不过这次运行clint还是会"Segmentation Fault"9。继续用truss跟踪，发现clint还需要这个目录"/root/.clint/plugins/python"，建好这个目录后clint终于能够正常运行了。
      </p><h2 id="N10079" class="ibm-h2">案例二：vim启动速度明显变慢</h2><p>操作系统：FreeBSD-5.2.1-release</p><p>vim版本为6.2.154，从命令行运行vim后，要等待近半分钟才能进入编辑界面，而且没有任何错误输出。仔细检查了.vimrc和所有的vim脚本都没有错误配置，在网上也找不到类似问题的解决办法，难不成要hacking source code？没有必要，用truss就能找到问题所在：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_164403" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># truss -f -D -o vim.truss vim</code></div></div></td></tr></tbody></table></div></div></div></span><p>这里-D参数的作用是：在每行输出前加上相对时间戳，即每执行一条系统调用所耗费的时间。我们只要关注哪些系统调用耗费的时间比较长就可以了，用less仔细查看输出文件vim.truss，很快就找到了疑点：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_326342" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">735: 0.000021511 socket(0x2,0x1,0x0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4 (0x4)</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">735: 0.000014248 setsockopt(0x4,0x6,0x1,0xbfbfe3c8,0x4) = 0 (0x0)</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">735: 0.000013688 setsockopt(0x4,0xffff,0x8,0xbfbfe2ec,0x4) = 0 (0x0)</code></div><div class="line number4 index3 alt1"><code class="htmlscript plain">735: 0.000203657 connect(0x4,{ AF_INET 10.57.18.27:6000 },16) ERR#61 'Connection refused'</code></div><div class="line number5 index4 alt2"><code class="htmlscript plain">735: 0.000017042 close(4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0 (0x0)</code></div><div class="line number6 index5 alt1"><code class="htmlscript plain">735: 1.009366553 nanosleep(0xbfbfe468,0xbfbfe460) = 0 (0x0)</code></div><div class="line number7 index6 alt2"><code class="htmlscript plain">735: 0.000019556 socket(0x2,0x1,0x0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4 (0x4)</code></div><div class="line number8 index7 alt1"><code class="htmlscript plain">735: 0.000013409 setsockopt(0x4,0x6,0x1,0xbfbfe3c8,0x4) = 0 (0x0)</code></div><div class="line number9 index8 alt2"><code class="htmlscript plain">735: 0.000013130 setsockopt(0x4,0xffff,0x8,0xbfbfe2ec,0x4) = 0 (0x0)</code></div><div class="line number10 index9 alt1"><code class="htmlscript plain">735: 0.000272102 connect(0x4,{ AF_INET 10.57.18.27:6000 },16) ERR#61 'Connection refused'</code></div><div class="line number11 index10 alt2"><code class="htmlscript plain">735: 0.000015924 close(4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0 (0x0)</code></div><div class="line number12 index11 alt1"><code class="htmlscript plain">735: 1.009338338 nanosleep(0xbfbfe468,0xbfbfe460) = 0 (0x0)</code></div></div></td></tr></tbody></table></div></div></div></span><p>vim试图连接10.57.18.27这台主机的6000端口（第四行的connect（）），连接失败后，睡眠一秒钟继续重试（第6行的nanosleep（））。以上片断循环出现了十几次，每次都要耗费一秒多钟的时间，这就是vim明显变慢的原因。可是，你肯定会纳闷："vim怎么会无缘无故连接其它计算机的6000端口呢？"。问得好，那么请你回想一下6000是什么服务的端口？没错，就是X Server。看来vim是要把输出定向到一个远程X Server，那么Shell中肯定定义了DISPLAY变量，查看.cshrc，果然有这么一行：
        <code>setenv DISPLAY ${REMOTEHOST}:0</code>，把它注释掉，再重新登录，问题就解决了。
      </p><h2 id="N10091" class="ibm-h2">案例三：用调试工具掌握软件的工作原理</h2><p>操作系统：Red Hat Linux 9.0</p><p>用调试工具实时跟踪软件的运行情况不仅是诊断软件"疑难杂症"的有效的手段，也可帮助我们理清软件的"脉络"，即快速掌握软件的运行流程和工作原理，不失为一种学习源代码的辅助方法。下面这个案例展现了如何使用strace通过跟踪别的软件来"触发灵感"，从而解决软件开发中的难题的。</p><p>大家都知道，在进程内打开一个文件，都有唯一一个文件描述符（fd：file descriptor）与这个文件对应。而本人在开发一个软件过程中遇到这样一个问题：已知一个fd ，如何获取这个fd所对应文件的完整路径？不管是Linux、FreeBSD或是其它Unix系统都没有提供这样的API，怎么办呢？我们换个角度思考：Unix下有没有什么软件可以获取进程打开了哪些文件？如果你经验足够丰富，很容易想到lsof，使用它既可以知道进程打开了哪些文件，也可以了解一个文件被哪个进程打开。</p><p>好，我们用一个小程序来试验一下lsof，看它是如何获取进程打开了哪些文件。</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_515801" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">/* testlsof.c */</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">stdio.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">unistd.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">sys</code><code class="htmlscript plain">/types.h&gt;</code></div><div class="line number5 index4 alt2"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">sys</code><code class="htmlscript plain">/stat.h&gt;</code></div><div class="line number6 index5 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">fcntl.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="htmlscript plain">int main(void)</code></div><div class="line number8 index7 alt1"><code class="htmlscript plain">{</code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">open("/tmp/foo", O_CREAT|O_RDONLY);&nbsp;&nbsp;&nbsp; /* 打开文件/tmp/foo */</code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">sleep(1200);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 睡眠1200秒，以便进行后续操作 */</code></div><div class="line number11 index10 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">return 0;</code></div><div class="line number12 index11 alt1"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><p>将testlsof放入后台运行，其pid为3125。命令lsof -p 3125查看进程3125打开了哪些文件，我们用strace跟踪lsof的运行，输出结果保存在lsof.strace中：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_674138" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># gcc testlsof.c -o testlsof</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain"># ./testlsof &amp;</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">[1] 3125</code></div><div class="line number4 index3 alt1"><code class="htmlscript plain"># strace -o lsof.strace lsof -p 3125</code></div></div></td></tr></tbody></table></div></div></div></span><p>我们以"/tmp/foo"为关键字搜索输出文件lsof.strace，结果只有一条：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_372342" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># grep '/tmp/foo' lsof.strace</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">readlink("/proc/3125/fd/3", "/tmp/foo", 4096) = 8</code></div></div></td></tr></tbody></table></div></div></div></span><p>原来lsof巧妙的利用了/proc/nnnn/fd/目录（nnnn为pid）：Linux内核会为每一个进程在/proc/建立一个以其pid为名的目录用来保存进程的相关信息，而其子目录fd保存的是该进程打开的所有文件的fd。目标离我们很近了。好，我们到/proc/3125/fd/看个究竟：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_366585" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain"># cd /proc/3125/fd/</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain"># ls -l</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">total 0</code></div><div class="line number4 index3 alt1"><code class="htmlscript plain">lrwx------&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp; root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 64 Nov&nbsp; 5 09:50 0 -&gt; /dev/pts/0</code></div><div class="line number5 index4 alt2"><code class="htmlscript plain">lrwx------&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp; root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 64 Nov&nbsp; 5 09:50 1 -&gt; /dev/pts/0</code></div><div class="line number6 index5 alt1"><code class="htmlscript plain">lrwx------&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp; root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 64 Nov&nbsp; 5 09:50 2 -&gt; /dev/pts/0</code></div><div class="line number7 index6 alt2"><code class="htmlscript plain">lr-x------&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp; root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 64 Nov&nbsp; 5 09:50 3 -&gt; /tmp/foo</code></div><div class="line number8 index7 alt1"><code class="htmlscript plain"># readlink /proc/3125/fd/3</code></div><div class="line number9 index8 alt2"><code class="htmlscript plain">/tmp/foo</code></div></div></td></tr></tbody></table></div></div></div></span><p>答案已经很明显了：/proc/nnnn/fd/目录下的每一个fd文件都是符号链接，而此链接就指向被该进程打开的一个文件。我们只要用readlink()系统调用就可以获取某个fd对应的文件了，代码如下：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_820448" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">stdio.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">string.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">sys</code><code class="htmlscript plain">/types.h&gt;</code></div><div class="line number4 index3 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">unistd.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">fcntl.h</code><code class="htmlscript plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="htmlscript plain">#include &lt;</code><code class="htmlscript plain">sys</code><code class="htmlscript plain">/stat.h&gt;</code></div><div class="line number7 index6 alt2"><code class="htmlscript plain">int get_pathname_from_fd(int fd, char pathname[], int n)</code></div><div class="line number8 index7 alt1"><code class="htmlscript plain">{</code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">char buf[1024];</code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">pid_t&nbsp; pid;</code></div><div class="line number11 index10 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">bzero(buf, 1024);</code></div><div class="line number12 index11 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">pid = getpid();</code></div><div class="line number13 index12 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">snprintf(buf, 1024, "/proc/%i/fd/%i", pid, fd);</code></div><div class="line number14 index13 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">return readlink(buf, pathname, n);</code></div><div class="line number15 index14 alt2"><code class="htmlscript plain">}</code></div><div class="line number16 index15 alt1"><code class="htmlscript plain">int main(void)</code></div><div class="line number17 index16 alt2"><code class="htmlscript plain">{</code></div><div class="line number18 index17 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">int fd;</code></div><div class="line number19 index18 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">char pathname[4096];</code></div><div class="line number20 index19 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">bzero(pathname, 4096);</code></div><div class="line number21 index20 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">fd = open("/tmp/foo", O_CREAT|O_RDONLY);</code></div><div class="line number22 index21 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">get_pathname_from_fd(fd, pathname, 4096);</code></div><div class="line number23 index22 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">printf("fd=%d; pathname=%s\n", fd, pathname);</code></div><div class="line number24 index23 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">return 0;</code></div><div class="line number25 index24 alt2"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><p>【注】出于安全方面的考虑，在FreeBSD 5 之后系统默认已经不再自动装载proc文件系统，因此，要想使用truss或strace跟踪程序，你必须手工装载proc文件系统：mount -t procfs proc /proc；或者在/etc/fstab中加上一行：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_193806" class="syntaxhighlighter  htmlscript"><table role="none" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">proc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /proc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; procfs&nbsp; rw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</code></div></div></td></tr></tbody></table></div></div></div></span><p>ltrace不需要使用procfs。</p><!--CMA ID: 49172--><!--Site ID: 10--><!--XSLT stylesheet used to transform this file: dw-document-html-8.0.xsl-->
                                        <!-- Article Quiz -->
                                        
                                        <!-- Article Resources -->
                                        <div class="ibm-alternate-rule"><hr></div><h4 id="artrelatedtopics" class="ibm-h4">相关主题</h4><ul><li>truss(1) manual page</li><li>strace(1) manual page</li><li>ltrace(1) manual page</li><li>ptrace(2) manual page</li><li>lsof(1) manual page</li><li>Debugging with strace：
          <a href="https://web.archive.org/web/20200803220616/http://www.devchannel.org/devtoolschannel/03/10/24/2057246.shtml">http://www.devchannel.org/devtoolschannel/03/10/24/2057246.shtml</a></li></ul></div></div></div></div></div></div></main></div></div></body></html>
