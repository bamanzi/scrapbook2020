<!DOCTYPE html>
<html data-rh="lang" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link rel="stylesheet" type="text/css" href="cid:css-84de7fdf-fe70-476a-85b6-db75521a4056@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-2228218d-260b-4765-a8ad-3d0674f1407e@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-ad53d2e1-38fa-4a0f-b5c5-067e5f4189a5@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-14e9e3ed-5dab-486e-ab9d-2941a19afd5e@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-aea8cfbb-fa20-4f05-95ce-ff8a8de527f2@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-82638132-6b1a-4fdc-94b7-e441505137d7@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-ccf5afa4-98af-4a0b-bbaa-dfb72eef2bb7@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-c143f1d5-39bc-4859-9a2d-533d51cd93dd@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-2470ebf7-fa32-41c2-84d1-943b375a61f1@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-1d46f950-6da3-4a9a-a750-560da5ca75bc@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-5cd13d8d-591c-4b01-b1aa-fb96a096e69a@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-97a33aeb-a28d-48b8-b9b6-7e0e6821a98f@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-83f575ca-d48a-4ced-a5d5-7aa659248caf@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-ad791144-751d-498f-abfd-8084a3e5a271@mhtml.blink"><link rel="stylesheet" type="text/css" href="cid:css-24ad0ec9-b4fc-41e5-9d36-ce340f1f1b5a@mhtml.blink"><title>Building Portable Binaries. Attempting to self-contain application… | by Square Engineering | Square Corner Blog | Medium</title><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"><meta data-rh="true" name="theme-color" content="#000000"><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"><meta data-rh="true" property="al:ios:app_name" content="Medium"><meta data-rh="true" property="al:ios:app_store_id" content="828256236"><meta data-rh="true" property="al:android:package" content="com.medium.reader"><meta data-rh="true" property="fb:app_id" content="542599432471018"><meta data-rh="true" property="og:site_name" content="Medium"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-04-18T23:14:59.519Z"><meta data-rh="true" name="title" content="Building Portable Binaries. Attempting to self-contain application… | by Square Engineering | Square Corner Blog | Medium"><meta data-rh="true" property="og:title" content="Building Portable Binaries"><meta data-rh="true" property="twitter:title" content="Building Portable Binaries"><meta data-rh="true" name="twitter:site" content="@squareeng"><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/50ca4f3d75cd"><meta data-rh="true" property="al:android:url" content="medium://p/50ca4f3d75cd"><meta data-rh="true" property="al:ios:url" content="medium://p/50ca4f3d75cd"><meta data-rh="true" property="al:android:app_name" content="Medium"><meta data-rh="true" name="description" content="Deploying your code is the last major hurdle in getting shiny new features or important bug fixes out to users. However, making sure your application has everything it needs can be a chore. Three…"><meta data-rh="true" property="og:description" content="Attempting to self-contain application dependencies"><meta data-rh="true" property="twitter:description" content="Attempting to self-contain application dependencies"><meta data-rh="true" property="og:url" content="https://medium.com/square-corner-blog/building-portable-binaries-50ca4f3d75cd"><meta data-rh="true" property="al:web:url" content="https://medium.com/square-corner-blog/building-portable-binaries-50ca4f3d75cd"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" property="article:author" content="https://medium.com/@SquareEng"><meta data-rh="true" name="twitter:creator" content="@SquareEng"><meta data-rh="true" name="author" content="Square Engineering"><meta data-rh="true" name="robots" content="index,follow,max-image-preview:large"><meta data-rh="true" name="referrer" content="unsafe-url"><meta data-rh="true" name="twitter:label1" content="Reading time"><meta data-rh="true" name="twitter:data1" content="7 min read"><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="https://medium.com/osd.xml"><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="urn:download-error:https://miro.medium.com/fit/c/152/152/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="urn:download-error:https://miro.medium.com/fit/c/120/120/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="urn:download-error:https://miro.medium.com/fit/c/76/76/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="urn:download-error:https://miro.medium.com/fit/c/60/60/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/Medium-Avatar-500x500.svg" color="#171717"><link data-rh="true" rel="preconnect" href="https://glyph.medium.com/" crossorigin=""><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="unbound.css"><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="unbound.css"><link data-rh="true" rel="author" href="https://medium.com/@SquareEng"><link data-rh="true" rel="canonical" href="https://developer.squareup.com/blog/building-portable-binaries/"><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/50ca4f3d75cd"><link id="googleidentityservice" type="text/css" media="all" rel="stylesheet" href="style.css"><style>hcfy-result.__hcfy__result__loaded__.__hcfy__result__both__{border: 1px dotted}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><div></div><div class="l c"><div class="m n l"><div class="o p q r s t u"><div class="v w x y z ab ac ae af"><nav class="ag"><div class="ah ai aj ak d"><div class="al am an o ao u ap aq ar as at c"><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" aria-label="Homepage" rel="noopener follow" href="https://medium.com/"></a></div><div class="an l"></div></div><div class="ag h k j i bl"><div class="bq o br u bs aq bt c"><div class="bm bn bo bp"><a aria-label="Homepage" rel="noopener follow" href="https://medium.com/"></a></div><div class="cq cr o ao"></div></div></div><div class="ah ai aj ak d"><div class="l ap ar cz as at c"><div class="cx an cj cy"></div></div></div></nav></div><main class="dd de df dg dh di l dj"><div class="l"><div class="od" role="dialog" aria-modal="true" tabindex="-1"><div class="si sj dq ag ap sk sl op sm hg sn" aria-hidden="true" role="presentation"></div><div class="so ap sp sq sr si ag dl ss st su pg sv sw sx sy sz ta tb tc td" aria-hidden="true"><div class="te tf o ao fu u"><div class="o fu"></div><div class="o fu"><div></div><div class="l cj th"></div></div></div><div class="ti qd o br ct ao jz tj"></div></div></div><div class="dr l"><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"></div></div></div><div class="eu ev ew ex ey l"><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"><article><div class="l"><div class="ez fa fb fc fd fe ff dq fg dl l"></div><div class="l"><header class="pw-post-byline-header fh fi fj fk fl fm fn fo fp fq l"><div class="o u"><div class="o"><div class="eb l"><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" rel="noopener follow" href="https://medium.com/@SquareEng?source=post_page-----50ca4f3d75cd-----------------------------------"></a></div></div><div class="gs gt gu gv gw d"></div></div></header><span class="l"></span><section><div><div class="eg as hd he hf hg"></div><div class="hh hi hj hk hl"><div class=""><h1 id="0916" class="pw-post-title hm hn ho cg hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik et" data-selectable-paragraph="">Building Portable Binaries</h1></div><div class=""><h2 id="75bd" class="pw-subtitle-paragraph il hn ho cg b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bw" data-selectable-paragraph="">Attempting to self-contain application dependencies</h2></div><p id="890d" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph=""><em class="jz">Written by </em><a class="au ka" href="https://twitter.com/alexcoomans" rel="noopener ugc nofollow" target="_blank"><em class="jz">Alex Coomans</em></a><em class="jz">.</em></p><blockquote class="kb"><p id="eea9" class="kc kd ho cg ke kf kg kh ki kj kk jy bw" data-selectable-paragraph="">Heads up, we’ve moved! If you’d like to continue keeping up with the latest technical content from Square please visit us at our new home <a class="au ka" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="f426" class="pw-post-body-paragraph jd je ho jf b jg kl ip ji jj km is jl jm kn jo jp jq ko js jt ju kp jw jx jy hh et" data-selectable-paragraph="">Deploying your code is the last major hurdle in getting shiny new features or important bug fixes out to users. However, making sure your application has everything it needs can be a chore. Three typical approaches for preparing your application for deployment are:</p><ol class=""><li id="93f9" class="kq kr ho jf b jg jh jj jk jm ks jq kt ju ku jy kv kw kx ky et" data-selectable-paragraph="">Installing dependencies system-wide alongside the runtime</li><li id="df26" class="kq kr ho jf b jg kz jj la jm lb jq lc ju ld jy kv kw kx ky et" data-selectable-paragraph="">Shipping the dependencies with the app and relying on the system runtime</li><li id="2c48" class="kq kr ho jf b jg kz jj la jm lb jq lc ju ld jy kv kw kx ky et" data-selectable-paragraph="">Shipping both the runtime and dependencies with the app</li></ol><p id="b6d1" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">This post will talk about approach number three. But first, I’ll point out some of the problems we had with approach one and two, and how both options drove us to the third option.</p><p id="2c1c" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">With options one and two, your app is relying on the system to provide something. Normally that is perfectly fine, but imagine if you happen to upgrade your OS and it includes an update to your runtime. For example, Python is present on many Linux boxes. You may have just broken your app and caused downtime. With option one you may have also lost all system dependencies. Even if you try to reinstall them, they may not work with the newer runtime.</p><p id="128e" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">We’ve seen this happen before when an OS upgrade broke a handful of services relying on a system binary. These services were using an older MySQL shared object that disappeared after the OS upgrade. So, we looked for a better solution: option 3.</p><h1 id="8489" class="le lf ho cg lg lh li lj lk ll lm ln lo iu lp iv lq ix lr iy ls ja lt jb lu lv et" data-selectable-paragraph="">Why not use X?</h1><p id="3917" class="pw-post-body-paragraph jd je ho jf b jg lw ip ji jj lx is jl jm ly jo jp jq lz js jt ju ma jw jx jy hh et" data-selectable-paragraph="">When looking for solutions, we didn’t find anything that completely isolated both the runtime and dependencies in the way that we needed. Instead, we turned to two, well-known — if somewhat obscure — pieces of the Linux stack: <a class="au ka" href="http://en.wikipedia.org/wiki/Shebang_(Unix)" rel="noopener ugc nofollow" target="_blank">shebangs</a> and <a class="au ka" href="http://wikipedia.org/wiki/Rpath" rel="noopener ugc nofollow" target="_blank">rpaths</a>.</p><p id="5dbe" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Shebangs are the first line of scripts — like /bin/bash or /usr/bin/env ruby — that begin with #!. The kernel reads #! and will execute the script with this interpreter.</p><p id="d52f" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">The rpath is the runtime search path for shared libraries and is hard coded into the header of the compiled binary. This allows the binary to search for other parts of itself or core things like <a class="au ka" href="http://en.wikipedia.org/wiki/C_standard_library" rel="noopener ugc nofollow" target="_blank">libc</a>, which provides the core C standard library.</p><p id="4ddf" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">All this work started with a simple need to fix an application that was relying on the system to provide all of its dependencies and broke when deploying to new machines. While Virtualenv came up as a solution, it doesn’t help with the Python installation problem. As a result, once I had a relocatable Python, I installed the dependencies like normal — thus Virtualenv wouldn’t provide anything extra.</p><h1 id="3588" class="le lf ho cg lg lh li lj lk ll lm ln lo iu lp iv lq ix lr iy ls ja lt jb lu lv et" data-selectable-paragraph="">Shebangs</h1><p id="9fde" class="pw-post-body-paragraph jd je ho jf b jg lw ip ji jj lx is jl jm ly jo jp jq lz js jt ju ma jw jx jy hh et" data-selectable-paragraph="">The biggest drawback with shebangs is that they don’t support relative paths with respect to the binary location. You need to either hard code a system path or use a path that is relative to your current working directory when executed. The first option doesn’t work when relocating binaries, and the second option doesn’t work because it requires you to cd into the correct directory.</p><p id="1855" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Here’s an example pip shim from a version of Python that I compiled:</p><pre class="mb mc md me fq mf mg mh"><span id="6486" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">#!/home/vagrant/python/bin/python<br># EASY-INSTALL-ENTRY-SCRIPT: 'pip==1.3.1','console_scripts','pip'<br>__requires__ = 'pip==1.3.1'<br>import sys<br>from pkg_resources import load_entry_point</span><span id="d8d0" class="et mi lf ho mj b ch mn mo mp mq mr ml l mm" data-selectable-paragraph="">if __name__ == '__main__':<br>    sys.exit(<br>        load_entry_point('pip==1.3.1', 'console_scripts', 'pip')()<br>    )</span></pre><p id="877e" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">You’ll notice the #!/home/vagrant/python/bin/python shebang, which fails if I move the Python binary elsewhere.</p><p id="4d05" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Certain languages have supported tricks that make this problem easier to solve. For example, a long time ago kernels didn’t support shebangs; so, you’d have to make sure you were running in your interpreter. Inspired by this work around (and after much trial and error), I came up with the following:</p><pre class="mb mc md me fq mf mg mh"><span id="620a" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">#!/bin/bash -e<br>"eval" '$(cd `dirname $0`; pwd)/python $(cd `dirname $0`; pwd)/$(basename $0) "$@" &amp;&amp; exit 0'<br># python code</span></pre><p id="2db7" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">When executed in Python, strings next to each other are simply concatenated and act as a no-op. However in Bash, it’s executed as code with the whole quoted piece treated as one argument to eval — which is exactly what we needed.</p><p id="6c1d" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">I had to use the eval and exit 0 commands paired with the -e flag instead of exec due to the way it expects arguments, because otherwise you’d end up with a command like:</p><pre class="mb mc md me fq mf mg mh"><span id="ed3e" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">"/home/vagrant/python/bin/python /home/vagrant/python/bin/pip"</span></pre><p id="199b" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">The tricky part is that the space is treated as a literal space in the argument name, but when printed it is no different than the correct set of arguments:</p><pre class="mb mc md me fq mf mg mh"><span id="3f7e" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">"/home/vagrant/python/bin/python" "/home/vagrant/python/bin/pip"</span></pre><p id="0c64" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">The single quotes were the final piece that took me a while to get correct so that the $@ (i.e. the arguments to the script), were passed along correctly.</p><h1 id="22cf" class="le lf ho cg lg lh li lj lk ll lm ln lo iu lp iv lq ix lr iy ls ja lt jb lu lv et" data-selectable-paragraph="">RPATH</h1><p id="3d12" class="pw-post-body-paragraph jd je ho jf b jg lw ip ji jj lx is jl jm ly jo jp jq lz js jt ju ma jw jx jy hh et" data-selectable-paragraph="">An rpath for an executable is a header in a program that helps the linker find the needed shared objects at runtime. A shared object is a set of compiled code that is intended to be shared amongst a bunch of different binaries. Libc is the best example of a shared object as it is required by just about everything. Here are some examples of the headers for /bin/bash:</p><pre class="mb mc md me fq mf mg mh"><span id="f7ab" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ readelf -d /bin/bash<br>Dynamic section at offset 0xd3738 contains 26 entries:<br>  Tag        Type                         Name/Value<br> 0x0000000000000001 (NEEDED)             Shared library: [libtinfo.so.5]<br> 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]<br> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]<br>(other header information)</span></pre><p id="6d8f" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">You’ll notice bash requires libc, libdl, and libtinfo. Running ldd on that binary gives you the exact locations of the dependency resolution the linker has done:</p><pre class="mb mc md me fq mf mg mh"><span id="617c" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ ldd /bin/bash<br>    linux-vdso.so.1 =&gt;  (0x00007fff463ff000)<br>    libtinfo.so.5 =&gt; /lib64/libtinfo.so.5 (0x0000003415400000)<br>    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x0000003412c00000)<br>    libc.so.6 =&gt; /lib64/libc.so.6 (0x0000003413000000)<br>    /lib64/ld-linux-x86-64.so.2 (0x0000003412800000)</span></pre><p id="57b3" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">ldd will report the locations of the shared objects it finds, but it ignores the rpath (if present). bash doesn’t use an rpath, but here’s an example of the Python we’ll be compiling soon to help reach option three (i.e. shipping both the runtime and dependencies with the app):</p><pre class="mb mc md me fq mf mg mh"><span id="5807" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ readelf -d /example/python/bin/python<br>Dynamic section at offset 0x8f0 contains 26 entries:<br>  Tag        Type                         Name/Value<br> 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]<br> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]<br> 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]<br> 0x0000000000000001 (NEEDED)             Shared library: [libutil.so.1]<br> 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]<br> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]<br> 0x000000000000000f (RPATH)              Library rpath: [$ORIGIN/../lib]</span></pre><p id="d90e" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Notice the RPATH line? That’s the magic that allows us to relocate binaries. It’s specifically important for Python, because the binary requires a shared object. That $ORIGIN variable is also super important as it allows you to make paths relative to the binary. In this case, Python is expected to look in /example/lib for shared objects, along with the default linker locations. The man page for <a class="au ka" href="http://man7.org/linux/man-pages/man8/ld.so.8.html" rel="noopener ugc nofollow" target="_blank">ld.so</a> has more details.</p><p id="3ff2" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">While that magic is awesome, actually going from source code to an actual binary is somewhat difficult. Due to the fact that variables in shell are of the form $var, nested calls to a shell can cause the variable to be interpolated or malformed. (Note: For this rpath to work, the literal string $ORIGIN needs to be present.)</p><p id="e835" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">I know, this is a cliffhanger. Why did I choose option three? Hold tight. You first need background on why I was working with rpaths. I was using Python and planned to compile mod_wsgi as my application server, but it requires Python to be a shared object. As a result, when compiling Python you can give it the — enable-shared flag to have it build the shared object. The only downside is that the Python interpreter now needs to be able to find that shared object. After my first attempt compiling a default Python build, I ended up this error:</p><pre class="mb mc md me fq mf mg mh"><span id="68c5" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ /example/python/bin/python<br>/home/vagrant/python/bin/python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory</span></pre><p id="5a6c" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Well, that wasn’t what I wanted. I needed to do one of the following:</p><ol class=""><li id="8054" class="kq kr ho jf b jg jh jj jk jm ks jq kt ju ku jy kv kw kx ky et" data-selectable-paragraph="">Set the LD_LIBRARY_PATH at runtime.</li><li id="ae5c" class="kq kr ho jf b jg kz jj la jm lb jq lc ju ld jy kv kw kx ky et" data-selectable-paragraph="">Set the RPATH at compile time so it references the correct libpython.sowhen executed.</li></ol><p id="c741" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">The biggest downside with LD_LIBRARY_PATH is it needs to be set as an environment variable, which is a bit of a pain to remember everytime you want to use Python. Instead, I decided to go with option number two (RPATH), which led to me to this first attempt at compiling with an rpath:</p><pre class="mb mc md me fq mf mg mh"><span id="6bb3" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">LDFLAGS='-Wl,-rpath=$ORIGIN/../lib' ./configure --prefix=/example/python --enable-shared</span></pre><p id="b726" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">The configure runs fine, so make should be a piece of cake:</p><pre class="mb mc md me fq mf mg mh"><span id="e11e" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ make<br>...<br>gcc -pthread -shared -Wl,-rpath=RIGIN/../lib -Wl,-hlibpython2.7.so.1.0 -o libpython2.7.so.1.0 Modules/getbuildinfo.o Parser/bitset.o Parser/metagrammar.o Parser/firstsets.o ...  Modules/pwdmodule.o  Modules/_sre.o  Modules/_codecsmodule.o -lpthread -ldl  -lutil  -lm ; \<br>        ln -f libpython2.7.so.1.0 libpython2.7.so;<br>...</span></pre><p id="0555" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">Notice the RIGIN/../lib missing the $O portion? The variable needs to be passed all the way to the linker as $ORIGIN/../lib for this trick to work. After a fair amount of trial and error, the final command to get the variable passed to the linker correctly was:</p><pre class="mb mc md me fq mf mg mh"><span id="6697" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">LDFLAGS='-Wl,-rpath=\$$ORIGIN/../lib' ./configure --prefix=/example/python --enable-shared</span></pre><p id="154b" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">I was able to verify using the readelf I posted above, and the final confirmation came by running:</p><pre class="mb mc md me fq mf mg mh"><span id="ee6e" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ /example/python/bin/python<br>Python 2.7.8 (default, Aug 26 2014, 06:15:54)<br>[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2<br>Type "help", "copyright", "credits" or "license" for more information.<br>&gt;&gt;&gt;</span></pre><p id="73f6" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">If you’d like to triple check that it’s loading the correct library (i.e. your compiled one and not the system one if it happens to exists), you can use strace:</p><pre class="mb mc md me fq mf mg mh"><span id="b568" class="et mi lf ho mj b ch mk ml l mm" data-selectable-paragraph="">$ strace -e open,stat python/bin/python<br>...<br>open("/example/python/bin/../lib/tls/x86_64/libpython2.7.so.1.0", O_RDONLY) = -1 ENOENT (No such file or directory)<br>stat("/example/python/bin/../lib/tls/x86_64", 0x7fffa5a4d520) = -1 ENOENT (No such file or directory)<br>open("/example/python/bin/../lib/tls/libpython2.7.so.1.0", O_RDONLY) = -1 ENOENT (No such file or directory)<br>stat("/example/python/bin/../lib/tls", 0x7fffa5a4d520) = -1 ENOENT (No such file or directory)<br>open("/example/python/bin/../lib/x86_64/libpython2.7.so.1.0", O_RDONLY) = -1 ENOENT (No such file or directory)<br>stat("/example/python/bin/../lib/x86_64", 0x7fffa5a4d520) = -1 ENOENT (No such file or directory)<br>open("/example/python/bin/../lib/libpython2.7.so.1.0", O_RDONLY) = 3<br>...</span></pre><p id="56ce" class="pw-post-body-paragraph jd je ho jf b jg jh ip ji jj jk is jl jm jn jo jp jq jr js jt ju jv jw jx jy hh et" data-selectable-paragraph="">You can see that it eventually ends up looking in the /example/python/libdirectory.</p><h1 id="bd89" class="le lf ho cg lg lh li lj lk ll lm ln lo iu lp iv lq ix lr iy ls ja lt jb lu lv et" data-selectable-paragraph="">Conclusion</h1><p id="1346" class="pw-post-body-paragraph jd je ho jf b jg lw ip ji jj lx is jl jm ly jo jp jq lz js jt ju ma jw jx jy hh et" data-selectable-paragraph="">Obviously, choosing option three wasn’t the easiest or most obvious approach — compiling relocatable binaries can be hard (and sometimes impossible). However, using relative shebangs and rpaths help make it easier and allow more flexibility with your application deployment, while still being reliable.</p></div><div class="o ct ms mt mu mv" role="separator"><span class="mw ed ck mx my mz"></span><span class="mw ed ck mx my mz"></span><span class="mw ed ck mx my"></span></div><div class="hh hi hj hk hl"><div class="mb mc md me fq na"><a href="https://twitter.com/alexcoomans" rel="noopener  ugc nofollow" target="_blank"><div class="nb o ei"><div class="nc o br ct dj nd"><h2 class="cg hp ch ek el ne en eo nf eq es hn et">Alex Coomans (@alexcoomans) | Twitter</h2><div class="ng l"></div><div class="nh l"></div></div><div class="ni l"><div class="nj l nk nl nm ni nn no na"></div></div></div></a></div></div></div></section></div></div></article></div></div><div class="np l"></div><div class="l"></div><footer class="nq nr ns nt o ao nu nv nw nx ny nz oa ob c"><div class="l oc"><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"><div class="o u od"><div class="o ao fu"><div class="oe l"><span class="l fw of og e d"><div class="o ao fu"><div class="pw-multi-vote-icon cj oh oi oj ok ol om"><span><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fsquare-corner-blog%2F50ca4f3d75cd&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fsquare-corner-blog%2Fbuilding-portable-binaries-50ca4f3d75cd&amp;user=Square+Engineering&amp;userId=436631fa36bc&amp;source=-----50ca4f3d75cd---------------------clap_footer--------------"></a></span></div><div class="pw-multi-vote-count l ou ov ow ox oy oz pa"><div class="pb"></div></div></div></span><span class="l h g f pc pd"><div class="o ao fu"><div class="pw-multi-vote-icon cj oh oi oj ok ol om"><span><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fsquare-corner-blog%2F50ca4f3d75cd&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fsquare-corner-blog%2Fbuilding-portable-binaries-50ca4f3d75cd&amp;user=Square+Engineering&amp;userId=436631fa36bc&amp;source=-----50ca4f3d75cd---------------------clap_footer--------------"></a></span></div><div class="pw-multi-vote-count l ou ov ow ox oy oz pa"><div class="pb"></div></div></div></span></div><div class="pe o"></div></div><div class="o ao"><div class="ck" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div></div></div></div></div></div></div></div></footer></div><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"></div></div><div class="l"><div class="l pj od"><div class="l od"><div class="pk pl l pj"><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"><div class="o ao u"><h2 class="cg pm pn po pp lk pq pr ps lo jm pt pu lq jq pv pw ls ju px py lu el en eo nf eq es et"><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" href="https://medium.com/square-corner-blog?source=post_page-----50ca4f3d75cd-----------------------------------" rel="noopener follow">More from Square Corner Blog</a></h2><div class="ck" aria-hidden="false" aria-describedby="collectionFollowPopover" aria-labelledby="collectionFollowPopover"><span><button class="cg b ej ek gb qe gd ge gf gg gh bd gi gj gk gl gm gn go dl ck gp"><div class="o fu">Follow</div></button></span></div></div><div class="pz l"><p class="cg b ej ek bw">Buying and selling sound like simple things - and they should be. Somewhere along the way, they got complicated. At Square, we're working hard to make commerce easy for everyone.</p></div></div></div></div></div><div class="o ct"><div class="di dq ds dt du dv dw dx dy dz ea"><div class="qc l"></div></div></div></div></div></div></main><div class="dk dl c dm h k j i bl dn do dp"><div class="ag dq ck cj"><div class="l bs aq"><div class="dn o br"><div class="l oc"><div class="l c"><div class="l"><div class="qc o ao"><div class="pw-sign-in-button pe l"></div></div></div></div></div></div></div></div></div></div></div></div></div></div>








































</body><div style="all: initial;"></div></html>
