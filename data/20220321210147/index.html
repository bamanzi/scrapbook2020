<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="favicon.ico">
<script type="text/javascript" src="about:blank"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="robots" content="index,nofollow">

<title>QemuUserEmulation - Debian Wiki</title>
<script type="text/javascript" src="about:blank"></script>

<script type="text/javascript">/* Code removed by ScrapBook */</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="debian-wiki-1.0.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->


<link rel="alternate" title="Debian Wiki: QemuUserEmulation" href="https://wiki.debian.org/QemuUserEmulation?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=QemuUserEmulation&amp;ddiffs=1" type="application/rss+xml">


<link rel="Start" href="https://wiki.debian.org/%E9%A6%96%E9%A1%B5">
<link rel="Alternate" title="维基标记" href="https://wiki.debian.org/QemuUserEmulation?action=raw">
<link rel="Alternate" media="print" title="打印视图" href="https://wiki.debian.org/QemuUserEmulation?action=print">
<link rel="Search" href="https://wiki.debian.org/%E6%9F%A5%E6%89%BE%E7%BD%91%E9%A1%B5">
<link rel="Index" href="https://wiki.debian.org/%E6%A0%87%E9%A2%98%E7%B4%A2%E5%BC%95">
<link rel="Glossary" href="https://wiki.debian.org/%E8%AF%8D%E6%B1%87%E7%B4%A2%E5%BC%95">
<link rel="Help" href="https://wiki.debian.org/%E5%B8%AE%E5%8A%A9-%E6%8E%92%E7%89%88">
<style>
/* Code tidied up by ScrapBook */
</style></head>

<body dir="ltr" lang="zh">
<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="openlogo-50.png" alt="Debian" width="50" height="61"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="https://wiki.debian.org/QemuUserEmulation?action=login" id="login" rel="nofollow">登录</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="https://wiki.debian.org/%E9%A6%96%E9%A1%B5">首页</a></li><li class="wikilink"><a href="https://wiki.debian.org/%E6%9C%80%E6%96%B0%E6%94%B9%E5%8A%A8">最新改动</a></li><li class="wikilink"><a href="https://wiki.debian.org/%E6%9F%A5%E6%89%BE%E7%BD%91%E9%A1%B5">查找网页</a></li><li class="wikilink"><a href="https://wiki.debian.org/%E5%B8%AE%E5%8A%A9%E7%9B%AE%E5%BD%95">帮助目录</a></li><li class="current"><a href="#">QemuUserEmulation</a></li>
</ul>

</div>

<form id="searchform" method="get" action="https://wiki.debian.org/QemuUserEmulation">
<div>
<input name="action" value="fullsearch" type="hidden">
<input name="context" value="180" type="hidden">
<label for="searchinput" style="display: none;">搜索：</label>
<input id="searchinput" name="value" value="" size="20" alt="Search" class="disabled" type="text">
<input id="titlesearch" name="titlesearch" value="标题" alt="Search Titles" disabled="" type="submit">
<input id="fullsearch" name="fullsearch" value="正文" alt="Search Full Text" disabled="" type="submit">
</div>
</form>
<script type="text/javascript">/* Code removed by ScrapBook */</script>

<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="openlogo-50.png" alt="Debian" width="50" height="61"></a></div>

<div id="breadcrumbs"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><a href="https://wiki.debian.org/QemuUserEmulation?action=login" id="login-1" rel="nofollow">登录</a></li><li class="toggleCommentsButton" style="display: none;"><a href="#" class="nbcomment">注释</a></li><li><a class="nbinfo" href="https://wiki.debian.org/QemuUserEmulation?action=info" rel="nofollow">信息</a></li><li><a class="nbattachments" href="https://wiki.debian.org/QemuUserEmulation?action=AttachFile" rel="nofollow">附件</a></li><li>
<form class="actionsmenu" method="GET" action="https://wiki.debian.org/QemuUserEmulation">
<div>
    
    <select name="action">
        <option value="show">更多操作：</option><option value="raw">源码</option>
<option value="print">打印视图</option>
<option value="RenderAsDocbook">输出Docbook格式</option>
<option value="refresh">删除缓存</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="SpellCheck">拼写检查</option>
<option value="LikePages">相似网页</option>
<option value="LocalSiteMap">本站地图</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="RenamePage" disabled="" class="disabled">改名</option>
<option value="DeletePage" disabled="" class="disabled">删除</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="show" disabled="" class="disabled">订阅</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="show" disabled="" class="disabled">删除垃圾广告</option>
<option value="show" disabled="" class="disabled">恢复成此版本</option>
<option value="PackagePages">网页打包</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="Load">加载</option>
<option value="Save">保存</option>
<option value="SlideShow">SlideShow</option>
    </select>
    
    
</div>
<script type="text/javascript">/* Code removed by ScrapBook */</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="#">QemuUserEmulation</a></li>
</ul>

</h1>
</div>

<div id="page" dir="ltr" lang="en">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><p class="line867">
</p><h2 id="QEMU_User_Emulation">QEMU User Emulation</h2>
<span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line862">This page describes how to setup and use QEMU user emulation in a "transparent" fashion, allowing execution of non-native target executables just like native ones (i.e. <tt>./program</tt>). <span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span></p><p class="line874">In this text, "target" means the system being emulated, and "host" means the system where QEMU is running. <span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span></p><p class="line867"><strong>Note</strong> this setup is incompatible with <a class="http" href="http://www.scratchbox.org/">Scratchbox</a> (both use the binfmt_misc module to register the same formats), so it's recommended to remove it (or stop its init script) before continuing. <span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span></p><p class="line867">
</p><h3 id="Installing_packages">Installing packages</h3>
<span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span><p class="line862">The binfmt-support package contains a helper script to easily register/unregister binary formats with the kernel using the <a class="interwiki" href="https://en.wikipedia.org/wiki/binfmt_misc" title="WikiPedia">binfmt_misc</a> module. <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></p><ol type="1"><li>Install qemu, binfmt-support, and qemu-user-static: <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span></li></ol><p class="line867"><span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></p><pre><span class="anchor" id="line-1"></span># apt install qemu binfmt-support qemu-user-static</pre><span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><ol type="1"><li>Check whether the binfmt entries were successfully registered: <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span></li></ol><p class="line867"><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span></p><pre><span class="anchor" id="line-1-1"></span># update-binfmts --display</pre><span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><ul><li style="list-style-type: none;">This command should print entries for each supported target user emulator, except for the host system. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></li></ul><p class="line867">
</p><h3 id="Adjusting_the_system">Adjusting the system</h3>
<span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line874">Depending on the your kernel settings, you may need to set 'vm.mmap_min_addr=0' sysctl option to allow a program being run under a regular user, not root. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></p><p class="line867">
</p><h3 id="Running_dynamically_linked_executables">Running dynamically linked executables</h3>
<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line874">With the instructions above, you should be able to run statically linked target executables. To be able to run dynamically linked binaries, QEMU needs to have access to the target ELF interpreter. The libc6 package for the target architecture contains the target's ELF interpreter used by QEMU.  <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></p><p class="line874">Installing this can be done with multiarch from wheezy onwards, or with dpkg-cross on earlier (pre-multiarch) releases. <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></p><p class="line867">
</p><h3 id="Installing_the_target_C_libraries_with_multiarch">Installing the target C libraries with multiarch</h3>
<span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><p class="line874">For example purposes, let's assume the target system is "armhf". <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span></p><p class="line867"><span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span></p><pre><span class="anchor" id="line-1-2"></span>sudo dpkg --add-architecture armhf
<span class="anchor" id="line-2"></span>sudo apt update
<span class="anchor" id="line-3"></span>sudo apt install libc6:armhf</pre><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><p class="line874">That's it.  <span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span></p><p class="line867">
</p><h3 id="Installing_the_target_C_libraries_with_dpkg-cross">Installing the target C libraries with dpkg-cross</h3>
<span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line862">If the target Debian package cannot be installed directly on the host, we need to use <a class="interwiki" href="https://packages.debian.org/dpkg-cross" title="DebianPkg">dpkg-cross</a> to "cross-install" the package. <span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span></p><p class="line874">For example purposes, let's assume the target system is "armel". <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span></p><ol type="1"><li>Install the dpkg-cross package: <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span></li></ol><p class="line867"><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span></p><pre><span class="anchor" id="line-1-3"></span># apt install dpkg-cross</pre><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><ol type="1"><li>Now download the target libc6 package from one of the Debian mirrors and install it using dpkg-cross: <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span></li></ol><p class="line867"><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span></p><pre><span class="anchor" id="line-1-4"></span># dpkg-cross -i -a arm libc6_&lt;version&gt;_armel.deb</pre><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line867">
</p><h3 id="Point_QEMU_to_the_target_linux_loader">Point QEMU to the target linux loader</h3>
<span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line862">Under multiarch the target arch loader is in the usual place (/lib/&lt;triplet&gt;) so nothing special is needed. If using dpkg-cross it's installed in a non-standard path so you need to tell QEMU about that. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span></p><p class="line874">for example, for the armel architecture: add the line <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span></p><p class="line874">EXTRA_OPTS="-L /usr/arm-linux-gnueabi" <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span></p><p class="line874">to the /etc/qemu-binfmt.conf. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span></p><p class="line874">for armhf add: <span class="anchor" id="line-79"></span>EXTRA_OPTS="-L /usr/arm-linux-gnueabihf" <span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span></p><p class="line867">
</p><h3 id="Testing_the_emulation_environment">Testing the emulation environment</h3>
<span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><p class="line874">We will use the "hello" ARM Debian package to test the new environment. <span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span></p><ol type="1"><li><p class="line862">Download the hello package (e.g. from <a class="http" href="http://deb.debian.org/debian/pool/main/h/hello/hello_version_armel.deb">http://deb.debian.org/debian/pool/main/h/hello/hello_version_armel.deb</a>) <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span></p></li><li class="gap">Unpack it with the command: <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span></li></ol><p class="line867"><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span></p><pre><span class="anchor" id="line-1-5"></span>$ dpkg -x hello_version_armel.deb /tmp/hello_armel</pre><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><ol type="1"><li><p class="line862">Finally, run the hello executable with: <span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span></p><pre><span class="anchor" id="line-1-6"></span>$ /tmp/hello_armel/usr/bin/hello</pre><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span></li></ol><p class="line874">It should print "Hello, world!". <span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span></p><p class="line874">That's it! You can now run non-native executables transparently, as long as QEMU supports the system calls used by it. <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span></p><p class="line867">
</p><h3 id="Appendix:_chrooting_into_target_file_systems">Appendix: chrooting into target file systems</h3>
<span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line874">To be able to chroot into a target file system, the qemu emulator for the target CPU needs to be available. You need first to install the qemu-user-static package: <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span></p><p class="line867"><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span></p><pre><span class="anchor" id="line-1-7"></span># apt install qemu-user-static</pre><span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line874">If you are using stretch or earlier, it also needs to be accessible from inside the chroot jail. From Debian buster and later, this isn't necessary because Linux will use the qemu binary from the host system instead of from the chroot.  <span class="anchor" id="line-110"></span>This means that you can use the dynamically linked qemu on buster or later but not stretch or earlier because the host libraries will not be accessible from inside the chroot. <span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span></p><p class="line874">If you are using stretch or earlier, make the emulator available for the target architecture inside the chroot at the path registered by binfmt-support. You can either bind-mount the binary into the chroot, or just copy it. Copying it means you won't have to copy it again, but it also means it won't get updates, while bind-mounting means you have to bind-mount  For example, for an ARM target file system, you need to do one of the following: <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span></p><p class="line867"><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span></p><pre><span class="anchor" id="line-1-8"></span># mount --bind /usr/bin/qemu-arm-static /target_fs/usr/bin
<span class="anchor" id="line-2-1"></span># cp /usr/bin/qemu-arm-static /target_fs/usr/bin</pre><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><p class="line874">If you are using systemd, then you can use systemd-nspawn to start a container: <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span></p><p class="line867"><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span></p><pre><span class="anchor" id="line-1-9"></span># apt install systemd-container
<span class="anchor" id="line-2-2"></span># systemd-nspawn -D /target_fs/</pre><span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><p class="line874">If you aren't using systemd-nspawn, then you may want to mount special filesystems for devices, terminals and processes from the host in the chroot: <span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span></p><p class="line867"><span class="anchor" id="line-129"></span><span class="anchor" id="line-130"></span></p><pre><span class="anchor" id="line-1-10"></span>for f in dev dev/pts sys proc run ; do mount --bind /$f tmp/$f ; done</pre><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><p class="line874">You should now be able to chroot into the file system: <span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span></p><p class="line867"><span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span></p><pre><span class="anchor" id="line-1-11"></span># chroot /target_fs/</pre><span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line867">
</p><h3 id="See_Also">See Also</h3>
<span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><ul><li><p class="line891"><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap">EmDebian/CrossDebootstrap</a> <span class="anchor" id="line-142"></span></p></li><li><p class="line891"><a href="https://wiki.debian.org/Embedded_Debian">Embedded_Debian</a> <span class="anchor" id="line-143"></span></p></li><li><p class="line891"><a class="https" href="https://qemu.readthedocs.io/en/latest/user/main.html">QEMU User space emulator</a>: upstream documentation <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span></p></li></ul><p class="line867">
</p><h3 id="TODO">TODO</h3>
<span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><ul><li>Modify Scratchbox to take advantage of the new qemu packages, instead of using its own internal qemu (possible?). <span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span></li></ul><p class="line867"></p><hr><p class="line874"> <span class="anchor" id="line-150"></span><a href="https://wiki.debian.org/CategoryEmdebian">CategoryEmdebian</a> <a href="https://wiki.debian.org/CategoryNotNative">CategoryNotNative</a> <span class="anchor" id="line-151"></span><span class="anchor" id="bottom"></span></p></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" dir="ltr" lang="zh">QemuUserEmulation  (<a class="nbinfo" href="https://wiki.debian.org/QemuUserEmulation?action=info" rel="nofollow">最后修改时间 2021-06-29 23:55:52</a>)</p>

<ul id="credits">
<li>Debian <a href="https://www.debian.org/legal/privacy">privacy policy</a>, Wiki <a href="https://wiki.debian.org/Teams/DebianWiki">team</a>, <a href="https://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="https://salsa.debian.org/debian/wiki.debian.org">config</a>.</li><li>Powered by <a href="https://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin</a> and <a href="https://moinmo.in/Python" title="MoinMoin is written in Python.">Python</a>, withhosting provided by <a href="https://www.man-da.de/">Metropolitan Area Network Darmstadt</a>.</li>
</ul>


</div>



</body><div style="all: initial;"></div>
</html>
